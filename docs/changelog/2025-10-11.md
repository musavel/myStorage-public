# 2025-10-11 (금) - UI 개선 및 백업 시스템 구축

## UI 개선: 공개 페이지 title 필드 검색/정렬 지원

### 배경
공개 컬렉션 페이지에서 검색/정렬 옵션이 필드 설정의 `searchable`, `sortable` 플래그에만 의존하여, title 필드가 비활성화되면 검색/정렬이 불가능했음.

### 개선 사항
**파일**: `frontend/app/collections/[slug]/page.tsx`

**검색 필드 선택**:
```tsx
// Before
.filter((field) => field.searchable === true)

// After
.filter((field) => field.searchable === true || field.key === 'title')
```

**정렬 필드 선택**:
```tsx
// Before
.filter((field) => field.sortable === true)

// After
.filter((field) => field.sortable === true || field.key === 'title')
```

### 효과
- ✅ title 필드는 항상 검색 가능
- ✅ title 필드는 항상 정렬 가능
- ✅ 필드 설정과 무관하게 기본적인 검색/정렬 기능 보장

---

## Scripts: 데이터베이스 백업 및 복원 시스템

### 배경
운영 중인 PostgreSQL과 MongoDB 데이터를 정기적으로 백업하고, 필요 시 복원할 수 있는 도구 필요

### 백업 스크립트 (`scripts/backup_db.sh`)

**기능**:
- Docker 컨테이너에서 PostgreSQL 덤프 (`pg_dump`)
- Docker 컨테이너에서 MongoDB 덤프 (`mongodump`)
- 타임스탬프 포함 자동 파일명 (`backup_YYYYMMDD_HHMMSS.tar.gz`)
- 백업 파일 자동 압축
- 옵션으로 오래된 백업 파일 정리 가능

**사용법**:
```bash
# 기본 백업
./scripts/backup_db.sh

# 백업 + 7일 이상 된 백업 삭제
./scripts/backup_db.sh --cleanup

# 백업 + 30일 이상 된 백업 삭제
./scripts/backup_db.sh --cleanup --cleanup-days 30
```

**옵션**:
- `--cleanup`: 백업 후 오래된 백업 파일 자동 삭제
- `--cleanup-days N`: N일 이상 된 백업 삭제 (기본값: 7일)
- `--help`: 도움말 표시

**백업 저장 위치**:
- `data/backups/backup_YYYYMMDD_HHMMSS.tar.gz`

**백업 내용**:
```
backup_YYYYMMDD_HHMMSS/
├── postgres_mystorage.sql    # PostgreSQL 덤프
├── mongodb/                   # MongoDB BSON 파일들
└── backup_info.txt           # 백업 정보
```

### 복원 스크립트 (`scripts/restore_db.sh`)

**기능**:
- 백업 파일 압축 해제
- PostgreSQL 데이터베이스 재생성 후 복원
- MongoDB 데이터베이스 삭제 후 복원
- 복원 전 사용자 확인 (`yes` 입력 필요)

**사용법**:
```bash
./scripts/restore_db.sh backup_20251011_153045.tar.gz
```

**주의사항**:
- ⚠️ 기존 데이터가 모두 삭제됨
- 복원 전 확인 메시지 표시
- 복원 후 백엔드 재시작 권장: `docker restart mystorage-backend-1`

### 디렉토리 구조

```
data/
└── backups/
    ├── backup_20251011_120000.tar.gz
    ├── backup_20251011_140000.tar.gz
    └── backup_20251011_160000.tar.gz
```

**`.gitignore` 추가**: `data/` 디렉토리는 git에서 제외

### 자동 백업 설정 (선택 사항)

**cron 설정 예시** (매일 자정 백업):
```bash
0 0 * * * /path/to/myStorage/scripts/backup_db.sh >> /var/log/mystorage_backup.log 2>&1
```

### 구현 세부사항

**Docker 컨테이너 감지**:
- `docker ps --filter "name=postgres"` - PostgreSQL 컨테이너 자동 감지
- `docker ps --filter "name=mongo"` - MongoDB 컨테이너 자동 감지

**PostgreSQL 백업**:
```bash
docker exec $POSTGRES_CONTAINER pg_dump -U $POSTGRES_USER -d $POSTGRES_DB > backup.sql
```

**MongoDB 백업**:
```bash
docker exec $MONGO_CONTAINER mongodump \
  --username="$MONGO_USER" \
  --password="$MONGO_PASSWORD" \
  --authenticationDatabase=admin \
  --db="$MONGO_DB" \
  --out=/tmp/mongodump
```

**PostgreSQL 복원**:
```bash
# 기존 연결 종료
docker exec $POSTGRES_CONTAINER psql -c "SELECT pg_terminate_backend(...)"

# DB 재생성
docker exec $POSTGRES_CONTAINER psql -c "DROP DATABASE IF EXISTS $POSTGRES_DB;"
docker exec $POSTGRES_CONTAINER psql -c "CREATE DATABASE $POSTGRES_DB;"

# 데이터 복원
docker exec -i $POSTGRES_CONTAINER psql -U $POSTGRES_USER -d $POSTGRES_DB < backup.sql
```

**MongoDB 복원**:
```bash
# 기존 DB 삭제
docker exec $MONGO_CONTAINER mongosh $MONGO_DB --eval "db.dropDatabase()"

# 데이터 복원
docker exec $MONGO_CONTAINER mongorestore \
  --username="$MONGO_USER" \
  --password="$MONGO_PASSWORD" \
  --authenticationDatabase=admin \
  --db="$MONGO_DB" \
  /tmp/mongodb_restore
```

### 문서 업데이트

**`scripts/README.md`**:
- 백업 및 복원 스크립트 사용법 추가
- 주의사항 및 예시 추가
