# 2025-10-11 (금) - UI 개선, 백업 시스템 구축, 공개 여부 제어 기능 추가

## 기능 추가: 컬렉션 및 아이템 공개 여부 제어

### 배경
관리자가 특정 컬렉션이나 아이템을 공개 페이지에서 숨기고 싶은 경우가 있음. 기본적으로 모든 항목은 공개이지만, 선택적으로 비공개 설정이 필요.

### 구현 내용

#### 1. 데이터베이스 스키마 변경

**PostgreSQL (Collections 테이블)**:
- `is_public` 컬럼 추가 (Boolean, 기본값: `true`)
- Alembic 마이그레이션 생성: `003_add_is_public_to_collections.py`
- 기존 컬렉션은 모두 `is_public = true`로 설정됨

**MongoDB (Items 컬렉션)**:
- 모든 items 문서에 `is_public: true` 필드 추가
- `items_books`: 43개 문서 업데이트
- `items_cartoons`: 399개 문서 업데이트

#### 2. 백엔드 API 업데이트

**Pydantic 스키마** (`backend/app/schemas/`):
```python
# collection.py
class CollectionBase(BaseModel):
    # ...
    is_public: bool = True

class CollectionUpdate(BaseModel):
    # ...
    is_public: Optional[bool] = None

# item.py
class ItemBase(BaseModel):
    # ...
    is_public: bool = True

class ItemUpdate(BaseModel):
    # ...
    is_public: Optional[bool] = None
```

**서비스 레이어** (`backend/app/services/`):
- `collection_service.py`: `get_all_collections(is_owner: bool = False)` 파라미터 추가
  - `is_owner=True`: 모든 항목 조회 (Owner)
  - `is_owner=False`: 공개 항목만 조회 (`is_public=True`)
- `item_service.py`:
  - `get_all_items(is_owner: bool = False)` 파라미터 추가
  - `get_item_by_id(is_owner: bool = False)` 파라미터 추가
  - `is_owner=False`일 때 MongoDB 쿼리에 `{"is_public": True}` 필터 적용

**API 엔드포인트** (`backend/app/api/`):
- `GET /api/collections/`: Owner 인증 기반 자동 필터링
  - Owner: 모든 컬렉션 조회 가능
  - 비로그인/일반 사용자: 공개 컬렉션만 조회
- `GET /api/items`: Owner 인증 기반 자동 필터링
  - Owner: 모든 아이템 조회 가능
  - 비로그인/일반 사용자: 공개 아이템만 조회
- `GET /api/items/{collection_id}/{item_id}`: Owner 인증 기반 자동 필터링
  - Owner: 모든 아이템 조회 가능
  - 비로그인/일반 사용자: 공개 아이템만 조회

**보안**:
- 프론트엔드에서 쿼리 파라미터 조작 방지
- 백엔드에서 `is_owner` Dependency로 자동 판단
- Owner 여부를 서비스 레이어에 직접 전달하여 필터링

#### 3. 프론트엔드 UI 추가

**타입 정의** (`frontend/lib/api.ts`):
```typescript
export interface Collection {
  // ...
  is_public: boolean;
}

export interface Item {
  // ...
  is_public: boolean;
}
```

**관리자 페이지** (`frontend/app/admin/`):
- 컬렉션 목록: 인증 토큰과 함께 API 호출 → Owner 인증되면 모든 컬렉션 조회
- 아이템 목록: 인증 토큰과 함께 API 호출 → Owner 인증되면 모든 아이템 조회

**공개 페이지** (`frontend/app/collections/`):
- 컬렉션 목록: 인증 없이 API 호출 → 공개 컬렉션만 조회
- 아이템 목록: 인증 없이 API 호출 → 공개 아이템만 조회

**모달 컴포넌트**:
- `CollectionModal.tsx`: 공개 여부 토글 UI 추가
- `ItemModal.tsx`: 공개 여부 토글 UI 추가
- 토글 스타일: 앰버색 (공개) / 회색 (비공개)

#### 4. 보안 강화된 필터링

**동작 방식**:
- 백엔드에서 JWT 토큰으로 Owner 여부 자동 판단
- Owner: 모든 항목 조회 가능 (`is_owner=True`)
- 비Owner: 공개 항목만 조회 (`is_owner=False`)
- 프론트엔드에서 쿼리 파라미터 조작해도 무효

### 파일 수정 내역

**Backend**:
- `backend/app/models/collection.py`: `is_public` 컬럼 추가
- `backend/alembic/versions/003_add_is_public_to_collections.py`: 마이그레이션 생성
- `backend/app/schemas/collection.py`: `is_public` 필드 추가
- `backend/app/schemas/item.py`: `is_public` 필드 추가
- `backend/app/core/auth.py`: `is_owner` Dependency 추가 (선택적 인증)
- `backend/app/services/collection/collection_service.py`: `show_hidden` 파라미터 추가
- `backend/app/services/item/item_service.py`: `show_hidden` 파라미터 추가
- `backend/app/api/collections.py`: Owner 인증 기반 자동 필터링 추가
- `backend/app/api/items.py`: Owner 인증 기반 자동 필터링 추가

**Frontend**:
- `frontend/lib/api.ts`: 타입 정의 업데이트 (`is_public` 추가)
- `frontend/components/CollectionModal.tsx`: 공개 여부 토글 UI 추가
- `frontend/components/ItemModal.tsx`: 공개 여부 토글 UI 추가
- `frontend/app/admin/collections/page.tsx`: 인증 토큰을 백엔드로 직접 전달
- `frontend/app/admin/collections/[slug]/items/page.tsx`: 인증 토큰을 백엔드로 직접 전달
- `frontend/app/collections/[slug]/page.tsx`: 공개 항목만 조회
- `frontend/app/api/collections/route.ts`: GET 요청 시 Authorization 헤더 전달 추가
- `frontend/app/api/items/route.ts`: GET 요청 시 Authorization 헤더 전달 추가

### 효과
- ✅ 관리자는 컬렉션/아이템 단위로 공개 여부 제어 가능
- ✅ 기본값은 모두 공개 (`is_public = true`)
- ✅ 공개 페이지에서는 비공개 항목이 자동으로 필터링됨
- ✅ Owner 인증된 사용자만 모든 항목을 볼 수 있음
- ✅ 프론트엔드에서 쿼리 파라미터 조작해도 백엔드에서 자동 차단

---

## UI 개선: 공개 페이지 title 필드 검색/정렬 지원

### 배경
공개 컬렉션 페이지에서 검색/정렬 옵션이 필드 설정의 `searchable`, `sortable` 플래그에만 의존하여, title 필드가 비활성화되면 검색/정렬이 불가능했음.

### 개선 사항
**파일**: `frontend/app/collections/[slug]/page.tsx`

**검색 필드 선택**:
```tsx
// Before
.filter((field) => field.searchable === true)

// After
.filter((field) => field.searchable === true || field.key === 'title')
```

**정렬 필드 선택**:
```tsx
// Before
.filter((field) => field.sortable === true)

// After
.filter((field) => field.sortable === true || field.key === 'title')
```

### 적용 파일
- `frontend/app/collections/[slug]/page.tsx` (공개 페이지)
- `frontend/app/admin/collections/[slug]/items/page.tsx` (관리자 페이지)

### 효과
- ✅ title 필드는 항상 검색 가능 (공개/관리자 모두)
- ✅ title 필드는 항상 정렬 가능 (공개/관리자 모두)
- ✅ 필드 설정과 무관하게 기본적인 검색/정렬 기능 보장

---

## Scripts: 데이터베이스 백업 및 복원 시스템

### 배경
운영 중인 PostgreSQL과 MongoDB 데이터를 정기적으로 백업하고, 필요 시 복원할 수 있는 도구 필요

### 백업 스크립트 (`scripts/backup_db.sh`)

**기능**:
- Docker 컨테이너에서 PostgreSQL 덤프 (`pg_dump`)
- Docker 컨테이너에서 MongoDB 덤프 (`mongodump`)
- 타임스탬프 포함 자동 파일명 (`backup_YYYYMMDD_HHMMSS.tar.gz`)
- 백업 파일 자동 압축
- 옵션으로 오래된 백업 파일 정리 가능

**사용법**:
```bash
# 기본 백업
./scripts/backup_db.sh

# 백업 + 7일 이상 된 백업 삭제
./scripts/backup_db.sh --cleanup

# 백업 + 30일 이상 된 백업 삭제
./scripts/backup_db.sh --cleanup --cleanup-days 30
```

**옵션**:
- `--cleanup`: 백업 후 오래된 백업 파일 자동 삭제
- `--cleanup-days N`: N일 이상 된 백업 삭제 (기본값: 7일)
- `--help`: 도움말 표시

**백업 저장 위치**:
- `data/backups/backup_YYYYMMDD_HHMMSS.tar.gz`

**백업 내용**:
```
backup_YYYYMMDD_HHMMSS/
├── postgres_mystorage.sql    # PostgreSQL 덤프
├── mongodb/                   # MongoDB BSON 파일들
└── backup_info.txt           # 백업 정보
```

### 복원 스크립트 (`scripts/restore_db.sh`)

**기능**:
- 백업 파일 압축 해제
- PostgreSQL 데이터베이스 재생성 후 복원
- MongoDB 데이터베이스 삭제 후 복원
- 복원 전 사용자 확인 (`yes` 입력 필요)

**사용법**:
```bash
./scripts/restore_db.sh backup_20251011_153045.tar.gz
```

**주의사항**:
- ⚠️ 기존 데이터가 모두 삭제됨
- 복원 전 확인 메시지 표시
- 복원 후 백엔드 재시작 권장: `docker restart mystorage-backend-1`

### 디렉토리 구조

```
data/
└── backups/
    ├── backup_20251011_120000.tar.gz
    ├── backup_20251011_140000.tar.gz
    └── backup_20251011_160000.tar.gz
```

**`.gitignore` 추가**: `data/` 디렉토리는 git에서 제외

### 자동 백업 설정 (선택 사항)

**cron 설정 예시** (매일 자정 백업):
```bash
0 0 * * * /path/to/myStorage/scripts/backup_db.sh >> /var/log/mystorage_backup.log 2>&1
```

### 구현 세부사항

**Docker 컨테이너 감지**:
- `docker ps --filter "name=postgres"` - PostgreSQL 컨테이너 자동 감지
- `docker ps --filter "name=mongo"` - MongoDB 컨테이너 자동 감지

**PostgreSQL 백업**:
```bash
docker exec $POSTGRES_CONTAINER pg_dump -U $POSTGRES_USER -d $POSTGRES_DB > backup.sql
```

**MongoDB 백업**:
```bash
docker exec $MONGO_CONTAINER mongodump \
  --username="$MONGO_USER" \
  --password="$MONGO_PASSWORD" \
  --authenticationDatabase=admin \
  --db="$MONGO_DB" \
  --out=/tmp/mongodump
```

**PostgreSQL 복원**:
```bash
# 기존 연결 종료
docker exec $POSTGRES_CONTAINER psql -c "SELECT pg_terminate_backend(...)"

# DB 재생성
docker exec $POSTGRES_CONTAINER psql -c "DROP DATABASE IF EXISTS $POSTGRES_DB;"
docker exec $POSTGRES_CONTAINER psql -c "CREATE DATABASE $POSTGRES_DB;"

# 데이터 복원
docker exec -i $POSTGRES_CONTAINER psql -U $POSTGRES_USER -d $POSTGRES_DB < backup.sql
```

**MongoDB 복원**:
```bash
# 기존 DB 삭제
docker exec $MONGO_CONTAINER mongosh $MONGO_DB --eval "db.dropDatabase()"

# 데이터 복원
docker exec $MONGO_CONTAINER mongorestore \
  --username="$MONGO_USER" \
  --password="$MONGO_PASSWORD" \
  --authenticationDatabase=admin \
  --db="$MONGO_DB" \
  /tmp/mongodb_restore
```

### 문서 업데이트

**`scripts/README.md`**:
- 백업 및 복원 스크립트 사용법 추가
- 주의사항 및 예시 추가
