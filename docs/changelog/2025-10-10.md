# 2025-10-10 (목) - AI 설정 DB 관리 & 문서 구조 개편

## AI 설정 DB 관리 시스템

### 문제 인식
**기존 방식**: localStorage에 AI 모델 설정 저장
- 브라우저마다 별도 설정 필요
- localStorage 삭제 시 설정 손실
- 다른 기기에서 다시 설정해야 함

**개선 필요**: DB에 저장하여 어디서든 동일한 설정 사용

### UserSettings 모델 및 테이블 추가
**PostgreSQL 스키마** (`backend/app/models/user_settings.py`):
```python
class UserSettings(Base):
    id: int (PK)
    user_email: str (unique, indexed)  # 소유자 이메일
    ai_text_model: str | None  # "provider/model_id" 형식
    ai_vision_model: str | None
    created_at: datetime
    updated_at: datetime
```

**Alembic 마이그레이션** (`backend/alembic/versions/002_add_user_settings.py`):
- user_settings 테이블 생성
- user_email 유니크 인덱스 추가
- upgrade/downgrade 함수 구현

**Pydantic 스키마** (`backend/app/schemas/user_settings.py`):
- UserSettingsBase, UserSettingsCreate, UserSettingsUpdate, UserSettingsResponse

### 백엔드 설정 시스템 전환 (메모리 → DB)
**settings.py 리팩토링** (`backend/app/services/ai/settings.py`):
- **Before**: 전역 변수 `_current_ai_settings` 딕셔너리
- **After**: PostgreSQL DB 기반
- `get_or_create_user_settings(db, email)`: 사용자 설정 가져오기/생성
- `get_current_settings(db)`: DB에서 설정 조회
- `update_settings(db, text_model, vision_model)`: DB에 저장
- 저장 형식: `"openai/gpt-4o-mini"` (provider/model_id)

**field_suggestion_service.py 수정**:
- `suggest_fields(db, ...)`: DB 세션 파라미터 추가
- `get_text_model(db)` 호출로 변경

**translation_service.py**: 변경 없음 (DeepL API 사용, AI 설정 불필요)

### API 엔드포인트 DB 연동
**backend/app/api/ai.py 수정**:
- `Depends(get_db)` 주입
- `/api/ai/set-models`: `update_settings(db, ...)` 호출
- `/api/ai/get-models`: `get_current_settings(db)` 호출
- `/api/ai/suggest-fields`: DB 세션 전달

### 프론트엔드 localStorage 완전 제거
**useAISettings 훅 간소화** (`frontend/hooks/useAISettings.ts`):

**Before**:
- localStorage에서 먼저 로드 (빠른 표시)
- 백엔드 API 호출
- 양쪽 동기화 로직

**After**:
- localStorage 관련 코드 완전 제거
- DB만 단일 소스로 사용 (Single Source of Truth)
- `fetchCurrentSettings()`: DB에서만 조회
- `saveSettings()`: DB에만 저장

### 장점
- ✅ **여러 브라우저/기기에서 동일한 설정**: 한 번만 설정하면 됨
- ✅ **설정 손실 방지**: localStorage 삭제, 쿠키 차단과 무관
- ✅ **영구 저장**: 서버 재시작 후에도 설정 유지
- ✅ **확장성**: 향후 테마, 언어 등 다른 사용자 설정 추가 용이

### 마이그레이션
- Alembic 스크립트 작성 (`002_add_user_settings.py`)
- Docker 재시작 시 자동 실행

---

## 문서 구조 개편

### 문서 통합 및 체계화
**기존 문제**:
- DEVELOPMENT.md가 1300줄 이상으로 관리 어려움
- README.md에 최근 업데이트 섹션 중복

**새로운 구조**:
```
docs/
├── README.md                # 📚 문서 인덱스
├── ARCHITECTURE.md          # 🏗️ 시스템 아키텍처
├── changelog/               # 일별 변경 이력
│   ├── 2025-10-05.md
│   ├── 2025-10-06.md
│   ├── ...
│   └── 2025-10-10.md
├── features/                # 기능별 상세 문서
│   ├── ai-models.md
│   ├── web-scraping.md
│   ├── field-mapping.md
│   └── collections.md
└── guides/                  # 사용자 가이드
    ├── ai-setup.md
    ├── authentication.md
    ├── collection-examples.md
    └── scraper-fields.md
```

### ARCHITECTURE.md 생성
- 시스템 아키텍처 전체 개요
- 하이브리드 DB 구조
- Service Layer Pattern
- 인증 시스템
- AI 시스템
- 웹 스크래핑 시스템
- 데이터 흐름
- 보안 및 성능 고려사항

### README.md 간소화
- 최근 업데이트 섹션 제거
- DEVELOPMENT.md 링크로 대체
- 프로젝트 소개와 빠른 시작에 집중

---

## 교보문고 스크래핑 개선

### 출판일 추출 버그 수정
**문제**:
- `.date` 셀렉터가 리뷰 수집일을 반환 (예: 2025.09.04)
- 원피스 1권의 실제 출판일은 2021년인데 잘못된 날짜 표시

**해결**:
- `.prod_info_text.publish_date` 셀렉터로 변경
- 형식: "출판사 · YYYY년 MM월 DD일" (예: "대원씨아이 · 2021년 10월 05일")
- 출판사와 출판일을 동시에 추출
- `·` 기준으로 split하여 각각 파싱

### 날짜 형식 표준화
**변환 로직 추가**:
- 입력: "2021년 10월 05일" (한글 포함)
- 출력: "2021-10-05" (ISO 8601 형식)
- 정규식: `r'(\d{4})년\s*(\d{1,2})월\s*(\d{1,2})일'`
- 월/일 자릿수 자동 보정 (zfill)

**장점**:
- ✅ 프론트엔드 date 타입 필드와 호환
- ✅ 정렬/필터링 용이
- ✅ 국제 표준 형식

### 문서 업데이트
- `docs/guides/scraper-fields.md` 업데이트
  - 교보문고 출판일 예시: "2021-10-05"
  - CSS 셀렉터 정보 수정
  - 날짜 변환 로직 설명 추가

---

## 스크래핑 필드 및 CSV 기능 개선

### page_count 필드 추가
**문제**:
- 기존 `pages` 필드명이 일반적이지 않아 필드 매핑 시 불편

**해결**:
- `page_count` 필드 추가 (교보문고, 알라딘 모두)
- `pages` 필드 유지 (하위 호환성)
- 두 필드 모두 동일한 값 저장

### description 텍스트 정제
**개선**:
- 개행문자(`\n`)와 연속 공백을 단일 공백으로 변환
- 정규식: `re.sub(r'\s+', ' ', text)`
- 교보문고, 알라딘 모두 적용

### CSV 일괄 등록 개선
**양식 다운로드 기능**:
- "양식 다운로드" 버튼 추가
- 파일명: `{collection_slug}_import_template.csv`
- UTF-8 BOM 포함

**CSV 형식 개선**:
- **컬럼 순서**: `title,URL,purchase_date`
- **title** (메모용): 어떤 책인지 확인용, 실제 데이터에는 미포함
- **URL** (필수): 스크래핑할 페이지 주소
- **purchase_date** (선택): 구매일 등 추가 정보

**백엔드 파싱 개선**:
- `csv.DictReader` 사용 (헤더 자동 인식)
- URL 필드 대소문자 무시 (url, URL, link, 주소)
- 추가 컬럼 데이터를 스크래핑 결과에 병합
- title 컬럼은 제외 (사용자 메모용)

**버그 수정**:
- `create_item_service()` 호출 시 파라미터 타입 오류 수정
- `ItemCreate` 객체로 변환 후 전달
