# 2025-10-10 (목) - AI 설정 DB 관리 & 문서 구조 개편

## AI 설정 DB 관리 시스템

### 문제 인식
**기존 방식**: localStorage에 AI 모델 설정 저장
- 브라우저마다 별도 설정 필요
- localStorage 삭제 시 설정 손실
- 다른 기기에서 다시 설정해야 함

**개선 필요**: DB에 저장하여 어디서든 동일한 설정 사용

### UserSettings 모델 및 테이블 추가
**PostgreSQL 스키마** (`backend/app/models/user_settings.py`):
```python
class UserSettings(Base):
    id: int (PK)
    user_email: str (unique, indexed)  # 소유자 이메일
    ai_text_model: str | None  # "provider/model_id" 형식
    ai_vision_model: str | None
    created_at: datetime
    updated_at: datetime
```

**Alembic 마이그레이션** (`backend/alembic/versions/002_add_user_settings.py`):
- user_settings 테이블 생성
- user_email 유니크 인덱스 추가
- upgrade/downgrade 함수 구현

**Pydantic 스키마** (`backend/app/schemas/user_settings.py`):
- UserSettingsBase, UserSettingsCreate, UserSettingsUpdate, UserSettingsResponse

### 백엔드 설정 시스템 전환 (메모리 → DB)
**settings.py 리팩토링** (`backend/app/services/ai/settings.py`):
- **Before**: 전역 변수 `_current_ai_settings` 딕셔너리
- **After**: PostgreSQL DB 기반
- `get_or_create_user_settings(db, email)`: 사용자 설정 가져오기/생성
- `get_current_settings(db)`: DB에서 설정 조회
- `update_settings(db, text_model, vision_model)`: DB에 저장
- 저장 형식: `"openai/gpt-4o-mini"` (provider/model_id)

**field_suggestion_service.py 수정**:
- `suggest_fields(db, ...)`: DB 세션 파라미터 추가
- `get_text_model(db)` 호출로 변경

**translation_service.py**: 변경 없음 (DeepL API 사용, AI 설정 불필요)

### API 엔드포인트 DB 연동
**backend/app/api/ai.py 수정**:
- `Depends(get_db)` 주입
- `/api/ai/set-models`: `update_settings(db, ...)` 호출
- `/api/ai/get-models`: `get_current_settings(db)` 호출
- `/api/ai/suggest-fields`: DB 세션 전달

### 프론트엔드 localStorage 완전 제거
**useAISettings 훅 간소화** (`frontend/hooks/useAISettings.ts`):

**Before**:
- localStorage에서 먼저 로드 (빠른 표시)
- 백엔드 API 호출
- 양쪽 동기화 로직

**After**:
- localStorage 관련 코드 완전 제거
- DB만 단일 소스로 사용 (Single Source of Truth)
- `fetchCurrentSettings()`: DB에서만 조회
- `saveSettings()`: DB에만 저장

### 장점
- ✅ **여러 브라우저/기기에서 동일한 설정**: 한 번만 설정하면 됨
- ✅ **설정 손실 방지**: localStorage 삭제, 쿠키 차단과 무관
- ✅ **영구 저장**: 서버 재시작 후에도 설정 유지
- ✅ **확장성**: 향후 테마, 언어 등 다른 사용자 설정 추가 용이

### 마이그레이션
- Alembic 스크립트 작성 (`002_add_user_settings.py`)
- Docker 재시작 시 자동 실행

---

## 문서 구조 개편

### 문서 통합 및 체계화
**기존 문제**:
- DEVELOPMENT.md가 1300줄 이상으로 관리 어려움
- README.md에 최근 업데이트 섹션 중복

**새로운 구조**:
```
docs/
├── README.md                # 📚 문서 인덱스
├── ARCHITECTURE.md          # 🏗️ 시스템 아키텍처
├── changelog/               # 일별 변경 이력
│   ├── 2025-10-05.md
│   ├── 2025-10-06.md
│   ├── ...
│   └── 2025-10-10.md
├── features/                # 기능별 상세 문서
│   ├── ai-models.md
│   ├── web-scraping.md
│   ├── field-mapping.md
│   └── collections.md
└── guides/                  # 사용자 가이드
    ├── ai-setup.md
    ├── authentication.md
    ├── collection-examples.md
    └── scraper-fields.md
```

### ARCHITECTURE.md 생성
- 시스템 아키텍처 전체 개요
- 하이브리드 DB 구조
- Service Layer Pattern
- 인증 시스템
- AI 시스템
- 웹 스크래핑 시스템
- 데이터 흐름
- 보안 및 성능 고려사항

### README.md 간소화
- 최근 업데이트 섹션 제거
- DEVELOPMENT.md 링크로 대체
- 프로젝트 소개와 빠른 시작에 집중

---

## 교보문고 스크래핑 개선

### 출판일 추출 버그 수정
**문제**:
- `.date` 셀렉터가 리뷰 수집일을 반환 (예: 2025.09.04)
- 원피스 1권의 실제 출판일은 2021년인데 잘못된 날짜 표시

**해결**:
- `.prod_info_text.publish_date` 셀렉터로 변경
- 형식: "출판사 · YYYY년 MM월 DD일" (예: "대원씨아이 · 2021년 10월 05일")
- 출판사와 출판일을 동시에 추출
- `·` 기준으로 split하여 각각 파싱

### 날짜 형식 표준화
**변환 로직 추가**:
- 입력: "2021년 10월 05일" (한글 포함)
- 출력: "2021-10-05" (ISO 8601 형식)
- 정규식: `r'(\d{4})년\s*(\d{1,2})월\s*(\d{1,2})일'`
- 월/일 자릿수 자동 보정 (zfill)

**장점**:
- ✅ 프론트엔드 date 타입 필드와 호환
- ✅ 정렬/필터링 용이
- ✅ 국제 표준 형식

### 문서 업데이트
- `docs/guides/scraper-fields.md` 업데이트
  - 교보문고 출판일 예시: "2021-10-05"
  - CSS 셀렉터 정보 수정
  - 날짜 변환 로직 설명 추가

---

## 스크래핑 필드 및 CSV 기능 개선

### page_count 필드 추가
**문제**:
- 기존 `pages` 필드명이 일반적이지 않아 필드 매핑 시 불편

**해결**:
- `page_count` 필드 추가 (교보문고, 알라딘 모두)
- `pages` 필드 유지 (하위 호환성)
- 두 필드 모두 동일한 값 저장

### description 텍스트 정제
**개선**:
- 개행문자(`\n`)와 연속 공백을 단일 공백으로 변환
- 정규식: `re.sub(r'\s+', ' ', text)`
- 교보문고, 알라딘 모두 적용

### CSV 일괄 등록 개선
**양식 다운로드 기능**:
- "양식 다운로드" 버튼 추가
- 파일명: `{collection_slug}_import_template.csv`
- UTF-8 BOM 포함

**CSV 형식 개선**:
- **컬럼 순서**: `title,URL,purchase_date`
- **title** (메모용): 어떤 책인지 확인용, 실제 데이터에는 미포함
- **URL** (필수): 스크래핑할 페이지 주소
- **purchase_date** (선택): 구매일 등 추가 정보

**백엔드 파싱 개선**:
- `csv.DictReader` 사용 (헤더 자동 인식)
- URL 필드 대소문자 무시 (url, URL, link, 주소)
- 추가 컬럼 데이터를 스크래핑 결과에 병합
- title 컬럼은 제외 (사용자 메모용)

**버그 수정**:
- `create_item_service()` 호출 시 파라미터 타입 오류 수정
- `ItemCreate` 객체로 변환 후 전달

---

## CSV 일괄 등록 실시간 진행률 표시

### 문제
**기존 방식**: 모든 스크래핑이 끝난 후 결과를 한 번에 표시
- 사용자는 진행 상황을 알 수 없음
- 대량 CSV 업로드 시 답답함
- 완료 후 즉시 DB에 등록되어 확인 불가

### 해결: Server-Sent Events (SSE) 스트리밍

**새 엔드포인트**: `/api/scraper/bulk-scrape-csv-stream`
- FastAPI `StreamingResponse` 사용
- 각 URL 처리 후 즉시 결과 전송
- SSE 형식: `data: {JSON}\n\n`

**이벤트 타입**:
- `start`: 시작 (total)
- `progress`: 진행 중 (current, total, success, failed, progress %, **item** 포함)
- `error_item`: 개별 아이템 실패 (에러 메시지 포함)
- `complete`: 완료 (total, success, failed)
- `error`: 전체 오류

**프론트엔드 구현**:
- Fetch API + ReadableStream 사용
- 실시간으로 진행률 업데이트
- 에러 목록 실시간 표시
- 프로그레스 바 애니메이션
- **완료 후 확인 단계 추가**: 등록된 아이템 미리보기 제공

**Next.js API Route**: `/api/scraper/bulk-scrape-csv-stream/route.ts`
- 스트리밍 응답을 그대로 전달
- `Content-Type: text/event-stream`

### 확인 UI/UX 개선
**완료 단계**:
- 등록 완료 후 자동 닫기 제거
- 녹색 확인 화면 표시
- 등록된 아이템 목록 미리보기 (제목, 저자)
- "확인 및 닫기" 버튼으로 수동 종료

**장점**:
- ✅ 등록 결과를 확인할 수 있음
- ✅ 실수로 등록된 경우 바로 확인 가능
- ✅ 어떤 아이템이 등록되었는지 명확히 파악

### 스크래핑 안정성 개선
**Timeout 설정 변경**:
- **Before**: 30초, `wait_until="networkidle"`
- **After**: 60초, `wait_until="domcontentloaded"`

**개선 효과**:
- ✅ 일괄 등록 시 timeout 에러 감소
- ✅ 페이지 로딩 속도 개선 (networkidle 대신 domcontentloaded)
- ✅ 단건과 일괄 등록의 안정성 동일하게 유지

---

## 아이템 대량 선택 삭제 기능

### 기능 추가
**아이템 관리 페이지에 체크박스 선택 및 대량 삭제 기능 추가**

**UI 개선**:
- 테이블 첫 번째 컬럼에 체크박스 추가
- 헤더 체크박스: 전체 선택/해제
- 각 행 체크박스: 개별 선택

**선택 삭제 버튼**:
- 선택된 아이템이 있을 때만 표시
- "🗑️ 선택 삭제 (N)" 형식
- 빨간색 버튼 (위험한 작업 시각화)
- 삭제 전 확인 다이얼로그

**삭제 로직**:
- `Promise.all`로 병렬 삭제
- 선택된 모든 아이템 동시 삭제
- 완료 후 자동 새로고침 및 선택 초기화

---

## UI/UX 개선 및 필드 관리 기능 강화

### Public 페이지 UI 정리
**등록일 표시 제거**:
- Public 페이지 상세 모달에서 등록일 제거
- Public 페이지 리스트뷰 테이블에서 등록일 컬럼 제거
- 이유: 일반 사용자에게 불필요한 정보

**용어 통일**:
- Admin 페이지: "등록일" 사용 (일관성 유지)
- Public 페이지: 등록일 제거

### 검색 기능 개선
**검색 필드 선택 기능 추가**:
- **Before**: 모든 필드에서 무조건 검색
- **After**: 검색 범위 선택 가능
  - 드롭다운으로 검색 필드 선택
  - "전체" (기본) 또는 검색 가능 필드 선택
  - Placeholder 동적 변경: "전체 검색..." / "{필드명} 검색..."

**구현**:
```tsx
<select value={searchField}>
  <option value="all">전체</option>
  {fields.filter(f => f.searchable === true).map(...)}
</select>
```

### 필드 관리 시스템 개선
**필드 정의에 표시 옵션 추가**:
```typescript
interface FieldDefinition {
  // 기존 속성들...

  // 새로운 옵션들
  sortable?: boolean;      // 정렬 가능 여부
  searchable?: boolean;    // 검색 가능 여부
  showInPublic?: boolean;  // public 페이지 표시 여부
}
```

**FieldDefinitionEditor UI 확장**:
- "정렬" 컬럼 (체크박스) 추가
- "검색" 컬럼 (체크박스) 추가
- "공개" 컬럼 (체크박스) 추가

**기본값**:
- `sortable`: false (명시적으로 선택)
- `searchable`: false (명시적으로 선택)
- `showInPublic`: true (기본 공개)

### 정렬 옵션 필터링
**Before**: 데이터 타입 기반 필터링
- text, number, date 타입 모두 표시
- "설명", "쪽수", "URL" 등 정렬에 무의미한 필드 노출

**After**: 관리자가 지정한 필드만 표시
- `sortable = true`인 필드만 정렬 옵션에 표시
- 제목, 저자, 출판일, 가격 등 실제 정렬에 유용한 필드만 노출

### 적용 범위
**정렬 필터링**:
- Public/Admin: `field.sortable === true`

**검색 필터링**:
- Public/Admin: `field.searchable === true`

**공개 여부**:
- Public 페이지: `field.showInPublic !== false`
- Admin 페이지: 모든 필드 표시

### 장점
- ✅ 관리자가 정렬/검색/공개 여부를 필드별로 세밀하게 제어
- ✅ 데이터 타입이 아닌 의미 기반 필터링
- ✅ 키 이름과 무관하게 작동
- ✅ 검색 범위가 명확해짐
- ✅ Public 페이지에서 민감 정보 숨김 가능

---

## 검색/정렬 결과 건수 표시

### 추가 기능
**결과 건수 표시**:
- 검색/정렬 바로 아래 "총 N건" 표시
- 검색 시: "총 N건 (전체 M건 중 검색됨)" 표시
- Public/Admin 페이지 모두 적용

---

## CSV 일괄 등록 Block 감지 및 에러 핸들링

### 문제 인식
**교보문고 Rate Limiting**:
- 일정 수 이상의 스크래핑 요청 시 차단
- 사용자가 10권 이상 등록 시 실패 가능성

### 해결: Block 감지 및 남은 URL CSV 다운로드
**Block 감지 로직**:
- Timeout, 403, "blocked", "rate limit" 키워드 감지
- 감지 시 즉시 중단 및 남은 URL 수집

**SSE 이벤트 추가**:
```json
{
  "type": "blocked",
  "index": 12,
  "message": "교보문고 차단 감지 (행 12). 잠시 후 다시 시도해주세요.",
  "total": 20,
  "success": 11,
  "failed": 0,
  "remaining_urls": [
    {"row": 12, "url": "https://..."},
    {"row": 13, "url": "https://..."},
    ...
  ]
}
```

**프론트엔드 UI**:
- Block 감지 시 경고 메시지 표시
- "남은 URL CSV 다운로드" 버튼 제공
- 다운로드된 CSV로 나중에 재시도 가능

**사용자 경험**:
1. CSV 업로드 → 스크래핑 시작
2. 12번째 항목에서 block 감지
3. 11개 성공적으로 등록
4. 경고 메시지: "12개 URL 처리 안 됨"
5. "남은 URL CSV 다운로드" 클릭
6. 잠시 후 다운로드한 CSV로 재시도

### 장점
- ✅ 제한 없이 시도 가능
- ✅ Block 발생 시 자동 중단
- ✅ 성공한 항목은 모두 저장
- ✅ 실패한 URL을 CSV로 제공하여 재시도 용이

---

## 백엔드 아키텍처 리팩토링 (Service Layer 분리)

### 배경
기존 `backend/app/api/` 파일들에 비즈니스 로직이 직접 구현되어 있어 코드 재사용성과 테스트 용이성이 낮았음.

### Auth 서비스 분리
**새 파일**: `backend/app/services/auth/auth_service.py`

**분리된 함수들**:
- `verify_google_token(token)`: Google ID Token 검증 및 이메일/이름 추출
- `verify_owner(email)`: 소유자 확인 (OWNER_EMAIL과 비교)
- `authenticate_google(token)`: 전체 인증 플로우 (토큰 검증 → 소유자 확인 → JWT 생성)
- `get_user_info(email)`: 사용자 정보 조회

**API 계층 간소화** (`backend/app/api/auth.py`):
- `/google` 엔드포인트: `auth_service.authenticate_google()` 호출
- `/me` 엔드포인트: `auth_service.get_user_info()` 호출
- 64줄로 축소, 모든 비즈니스 로직 제거

**개선 사항**:
- Google OAuth 토큰 검증에 `clock_skew_in_seconds=10` 추가 (시간 오차 허용)
- 이전 "Token used too early" 에러 해결

### Scraper 서비스 완전 분리
**리팩토링 전**: `backend/app/api/scraper.py` 370줄 (비즈니스 로직 포함)
**리팩토링 후**: 152줄 (59% 감소, 라우팅만 담당)

**새로 생성된 서비스 모듈**:

1. **`backend/app/services/scraper/mapping_service.py`**
   - `save_field_mapping()`: 필드 매핑 저장
   - `get_field_mapping()`: 필드 매핑 조회
   - `delete_field_mapping()`: 필드 매핑 삭제

2. **`backend/app/services/scraper/scraper_service.py`**
   - `scrape_url_with_mapping()`: URL 스크래핑 + 매핑 적용
   - `scrape_and_create()`: 스크래핑 + 아이템 생성
   - `bulk_scrape_and_create()`: 여러 URL 일괄 처리

3. **`backend/app/services/scraper/csv_processor.py`**
   - `process_csv_file()`: CSV 파싱 (URL, 추가 데이터, 원본 row 추출)
   - `get_collection_mapping()`: 컬렉션 매핑 설정 조회
   - `bulk_scrape_csv_stream()`: CSV 일괄 스크래핑 (SSE 스트리밍)

**삭제된 엔드포인트** (미사용):
- `/api/scraper/bulk-scrape`
- `/api/scraper/bulk-scrape-csv`

**프론트엔드 정리**:
- `app/api/scraper/bulk-scrape/route.ts` 삭제
- `app/api/scraper/bulk-scrape-csv/route.ts` 삭제

### CSV 스트리밍 버그 수정

**문제**: 차단 발생 시 `blocked` 이벤트 발생 후 `break`로 루프 종료했지만, 함수 끝에서 `complete` 이벤트가 무조건 발생하여 프론트엔드에서 "등록 완료"로 표시됨 (실제로는 88개 중 21개만 처리)

**원인**: Python generator 특성상 함수가 끝나면 마지막 코드 실행

**수정** (`csv_processor.py`):
```python
blocked = False  # 플래그 추가

# 차단 감지 시
if is_blocked:
    yield blocked_event
    blocked = True  # 플래그 설정
    break

# 완료 이벤트 (차단되지 않은 경우만)
if not blocked:
    yield complete_event
```

**프론트엔드 개선** (`BulkImportModal.tsx`):
- 불완전한 완료 감지: `success + failed < total`
- 콘솔 로그 추가: `[BLOCKED]`, `[COMPLETE]`
- SSE JSON 파싱 에러 처리 개선 (불완전한 chunk 무시)

### UI 개선

**공개 컬렉션 페이지** (`app/collections/[slug]/page.tsx`):
- 아이템 카드 테두리 강화: `border-slate-200` → `border-slate-700`
- 호버 시 그림자 효과 증가
- 흰색 배경에서 카드 구분 명확화

---

## Scripts: 시리즈 수동 업데이트 도구

### 배경
컬렉션 아이템에 시리즈 정보를 수동으로 일괄 설정할 필요

### 새 스크립트
**파일**: `scripts/update_series.py`

**기능**:
- 제목에 키워드가 포함된 아이템 필터링
- 시리즈명 일괄 설정
- DRY RUN 모드 지원

**CLI 옵션**:
```bash
# 옵션
-c, --collection   # 컬렉션 slug (필수)
-k, --keyword      # 제목 검색 키워드 (필수)
-s, --series       # 설정할 시리즈명 (필수)
--execute          # 실제 업데이트 (없으면 미리보기)
--only-empty       # 시리즈가 없는 아이템만 대상 (신규)
```

**사용 예시**:
```bash
# 미리보기
python scripts/update_series.py -c books -k "원피스" -s "원피스"

# 실제 업데이트
python scripts/update_series.py -c books -k "원피스" -s "원피스" --execute

# 시리즈가 없는 아이템만 업데이트
python scripts/update_series.py -c books -k "원피스" -s "원피스" --only-empty --execute
```

**구현 세부사항**:
- PostgreSQL에서 컬렉션 조회
- MongoDB에서 아이템 조회 및 업데이트
- 독립 실행 (백엔드 서버 불필요)
- `.env` 파일에서 DB 연결 정보 로드
- Click 라이브러리 사용 (CLI 인터페이스)

**문서**: `scripts/README.md` 추가
