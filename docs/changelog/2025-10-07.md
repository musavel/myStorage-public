# 2025-10-07 (화)


## 📅 2025-10-07 (화) - 필드 매핑 로직 재설계

#### 1. 필드 매핑 방향 전환 ✅
- **기존 방식**: 스크래핑한 필드 → 사용자 필드로 매핑 (스크래핑 결과 중심)
  - 문제점: 스크래핑 못 가져온 필드가 많음 (사이트별 파서 한계)
- **새로운 방식**: 사용자 필드 중심 매핑
  - 사용자가 정의한 필드 목록을 기준으로 UI 구성
  - 각 사용자 필드마다 스크래핑 데이터 중 선택
  - 스크래핑 데이터에 없으면 직접 수동 입력 가능

#### 2. FieldMappingModal 완전 재설계 ✅
- **새로운 UI 구조**:
  - 테이블: `내 필드` ← `스크래핑 데이터 선택` | `또는 직접 입력`
  - 각 사용자 필드마다 한 행씩 표시
  - 필드명, 라벨, 필수 여부 표시
- **매핑 방식**:
  - 드롭다운에서 스크래핑 데이터 선택 (미리보기 포함)
  - 스크래핑 데이터 선택 시 수동 입력 비활성화
  - 선택하지 않으면 직접 입력 가능
- **자동 매칭 개선**:
  - 사용자 필드 기준으로 유사한 스크래핑 필드 찾기
  - 정확히 일치하는 필드 우선, 부분 일치 fallback
- **매핑 통계**:
  - 매핑된/비어있는 필드 개수 표시
  - 매핑 설정 저장 옵션

#### 3. ItemModal 통합 ✅
- **URL 스크래핑 플로우**:
  1. URL 입력 → 스크래핑
  2. 저장된 매핑 자동 로드
  3. FieldMappingModal 표시
  4. 사용자가 매핑 확인/수정
  5. 매핑 적용 → 폼에 자동 입력
  6. 매핑 저장 옵션 선택 시 백엔드에 저장
- **매핑 형식 변환**:
  - 프론트엔드: `{ "책제목": "title", "저자명": "author" }` (사용자 → 스크래핑)
  - 백엔드: `{ "title": "책제목", "author": "저자명" }` (스크래핑 → 사용자)
  - 저장/불러오기 시 자동 변환

#### 4. BulkImportModal 지원 ✅
- **자동 매핑 적용**:
  - CSV 일괄 등록 시 저장된 매핑 자동 적용
  - 별도 UI 작업 불필요 (백엔드에서 처리)
  - `apply_field_mapping` 함수가 일괄 스크래핑에도 적용됨

#### 5. 사용자 경험 개선
- **직관적인 UI**:
  - 내 필드가 먼저 보임 (좌측)
  - 화살표(←)로 방향성 명확히 표시
  - 스크래핑 데이터 미리보기 (50자 제한)
- **유연한 입력**:
  - 스크래핑 데이터가 없어도 수동 입력으로 보완 가능
  - 필수 필드는 빨간 별표(*)로 표시
- **자동화**:
  - 한 번 매핑 저장하면 다음부터 자동 적용
  - 일괄 등록에도 동일한 매핑 사용

---

## 📅 2025-10-07 (화) - 버그 수정 및 개선

#### 1. 교보문고 ISBN 파싱 수정 ✅
- **문제**: 교보문고 페이지 구조 변경으로 ISBN 추출 실패 (null 반환)
- **1차 시도 실패 원인**: `.info_detail_wrap` 셀렉터가 더 이상 존재하지 않음
- **2차 시도 실패 원인**: `_parse_kyobo` 함수 내부에서 로컬 빈 `metadata`를 사용하여 이미 추출된 `image` 정보에 접근 불가
- **최종 해결**:
  - `_parse_kyobo` 함수에 `existing_metadata` 파라미터 추가
  - `existing_metadata['image']`에서 ISBN 추출
  - 패턴: `https://contents.kyobobook.co.kr/sih/fit-in/458x0/pdt/9791136287489.jpg`
  - 정규식: `/pdt/(\d{13})\.`
  - Fallback: 페이지 텍스트에서 정규식 검색
- **교훈**: 사이트별 특화 파싱 함수에서 일반 파싱에서 이미 추출된 메타데이터에 접근해야 할 경우, 파라미터로 전달 필요

#### 2. 알라딘 작가 정보 HTML 엔티티 디코딩 ✅
- **문제**: `尾田&#26628;一&#37070;` 형태로 표시됨
- **원인**: HTML 엔티티가 디코딩되지 않음
- **해결**: `html.unescape()` 함수 적용
  - `import html`
  - `text = html.unescape(text)`

#### 3. 아이템 생성 422 에러 수정 ✅
- **문제**: `POST /api/items` 요청 시 422 Unprocessable Content
- **원인**: `ItemCreate` 스키마에서 `title` 필드가 필수였으나 프론트엔드에서 전송하지 않음
- **해결**:
  - 백엔드 스키마: `title`을 Optional로 변경
  - 아이템 생성 서비스: metadata에서 title 자동 추출
    - 우선순위: `title`, `name`, `제목`, `이름` 필드
    - Fallback: 첫 번째 메타데이터 값 또는 "Untitled"

#### 4. 프론트엔드 빌드 에러 수정 ✅
- **문제**: `Type 'boolean | ""' is not assignable to type 'boolean | undefined'`
- **원인**: `hasScrapedData` 변수가 truthy 값을 반환 (빈 문자열 포함)
- **해결**: 명시적 boolean 변환 `!!(scrapedKey && scrapedData[scrapedKey] !== undefined)`
- **발생 파일**: `frontend/components/FieldMappingModal.tsx:244`

#### 5. 공통 이슈 해결 패턴
- **스크래퍼 안정성**: 웹사이트 구조 변경에 대비한 Fallback 로직 구현
- **타입 안전성**: TypeScript strict mode에서 명시적 타입 변환 중요
- **데이터 유연성**: 필수 필드를 Optional로 만들고 기본값/자동 추출 제공

---

