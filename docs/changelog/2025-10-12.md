# 2025-10-12 변경사항

## ✨ 새로운 기능

### CSV 일괄 등록 Fallback 메커니즘
- **기능**: 스크래핑 실패 시 CSV 데이터만으로 아이템 자동 생성
- **동작**:
  - 스크래핑 에러 발생 시 원본 CSV 데이터 추출
  - `source_url` 포함하여 메타데이터 구성
  - 필드 매핑 적용 후 MongoDB에 저장
  - UI에는 "실패"로 표시 (failed_count 증가)
  - 생성된 아이템 정보는 에러 이벤트에 포함
- **예시**:
  ```
  CSV: title=해리포터, url=https://..., purchase_date=2024-01-15
  스크래핑 실패 → MongoDB에 CSV 데이터 저장
  UI: "행 5: 스크래핑 실패 (네트워크 오류). CSV 데이터로 아이템 생성됨."
  ```
- **파일**: `backend/app/services/scraper/csv_processor.py` (209-269줄)

## 🐛 버그 수정

### 스크래핑 에러 처리 개선
- **문제**: 교보문고 차단 시 일반 에러와 구분 없이 처리되어 사용자에게 명확한 안내 부족
- **해결**:
  - "제목을 찾을 수 없습니다" 에러를 차단으로 명확히 식별
  - 단건 스크래핑: 사용자 친화적 메시지 표시 ("페이지가 차단되었거나 접근할 수 없습니다. 잠시 후 다시 시도해주세요.")
  - CSV 일괄 등록: 차단 감지 시 즉시 중단하고 남은 URL을 CSV로 다운로드 가능
- **파일**:
  - `backend/app/api/scraper.py` (85-100줄): ValueError 별도 처리
  - `backend/app/services/scraper/csv_processor.py` (177-207줄): 차단 감지 로직

### CSV 재등록 시 title 필드 누락 문제 해결
- **문제**: 남은 URL CSV를 다운로드하여 재등록하면 title 필드가 빈 값으로 저장됨
- **해결**:
  - `original_row`가 없거나 빈 경우에도 안전하게 처리
  - CSV 생성 시 대소문자 변형 대응 (`title` 또는 `Title`)
  - `escapeCsv` 함수 개선 (null/undefined 처리)
- **파일**: `frontend/components/BulkImportModal.tsx` (295-316줄)

### 이미지 필드 통일화
- **문제**:
  - 단건 스크래핑: `image_url`로 저장 (관리자 페이지 O, Public 페이지 O)
  - Bulk 스크래핑: `image`로 저장 (관리자 페이지 X, Public 페이지 O)
- **해결**:
  - 백엔드에서 스크래핑 시 `image` → `image_url`로 자동 변환
  - 기존 589개 데이터 마이그레이션 완료
  - 프론트엔드는 이미 fallback 지원 (`image_url` 우선, 없으면 `image` 사용)
- **파일**: `backend/app/services/scraper/web_scraper.py` (66-68줄)

## 🧹 코드 정리

### 사용하지 않는 함수 제거
- `scrape_urls()` 함수 제거 (배치 스크래핑, 실제로 사용되지 않음)
- `bulk_scrape_and_create()` 함수 제거 (대신 `bulk_scrape_csv_stream` 사용)
- 관련 import 정리 (`asyncio`, `List`)
- **파일**:
  - `backend/app/services/scraper/web_scraper.py`
  - `backend/app/services/scraper/scraper_service.py`

### 문서 업데이트
- `image` 필드 → `image_url` 통일 반영
- 교보문고/알라딘 필드 테이블에서 중복 `image` 필드 제거
- Open Graph/Twitter Card 메타데이터 추출 설명 업데이트
- 배치 스크래핑 예제 제거 (`scrape_urls()` 함수 삭제에 따름)
- 최근 업데이트 섹션에 2025-10-12 변경사항 추가
- **파일**: `docs/guides/scraper-fields.md`

### Pylance 경고 수정
- 사용하지 않는 매개변수 명시적 처리 (`_ = ...`)
- `__aexit__` 메서드: `exc_type`, `exc_val`, `exc_tb`
- `_parse_kyobo`, `_parse_aladin` 메서드: `soup` 파라미터
- **파일**: `backend/app/services/scraper/web_scraper.py`

## 📊 데이터 마이그레이션

### MongoDB 필드 통일화
- `items_cartoons` 컬렉션의 589개 문서에서 `metadata.image` → `metadata.image_url` 변경
- 기존 `metadata.image` 필드 삭제

## 🔧 기술적 개선사항

- **CSV Fallback 메커니즘**: 스크래핑 실패 시 데이터 손실 방지
- **에러 메시지 명확화**: 차단/일반 에러 구분
- **데이터 일관성**: 모든 이미지 필드가 `image_url`로 통일
- **CSV 처리 안정성**: 재등록 시 메타데이터 보존
- **코드 품질**: 사용하지 않는 코드 제거 및 경고 수정

## 📝 영향받는 기능

- ✅ 단건 URL 스크래핑
- ✅ CSV 일괄 등록
- ✅ 차단 감지 및 재시도
- ✅ 관리자 페이지 이미지 표시
- ✅ Public 페이지 이미지 표시
